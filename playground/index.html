<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <title>MaML Playground</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <style>
            #editor {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
            }
            html, body {
                height: 100%;
            }
        </style>
    </head>
    <body>

    <div class="container h-100">
        <div class="row">
            <button onClick="compileProgram()" type="button" class="btn btn-primary">Compile</button>
        </div>
        <div class="row h-100">
            <div class="col">
                <div id="editor"></div>
            </div>
            <div class="col">
                Column 1
            </div>
        </div>
    </div>


        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.1/ace.js"></script>

        <script>
            var editor = ace.edit("editor");

function base64ToArrayBuffer(base64) {
        var binary_string =  window.atob(base64);
        var len = binary_string.length;
        var bytes = new Uint8Array( len );
        for (var i = 0; i < len; i++)        {
                    bytes[i] = binary_string.charCodeAt(i);
                }
        return bytes.buffer;
}

function compileProgram() {
    var text = editor.getValue();
    fetch("/compile", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "code=" + encodeURIComponent(text)
    }).then(function(res) {
        if (res.ok) {
            return res.json();
        } else {
            return Promise.reject(res)
        }
    }).then(function(json) {
        var wasm = base64ToArrayBuffer(json.wasm)
        return WebAssembly.instantiate(wasm);
    }).then(function(module) {
        window.exports = module.instance.exports;
    }).catch(function(err) {
        err.json()
            .then(function(msg) {
                alert(msg.error);
            })
    })
}
        </script>
    </body>
</html>
